<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Recetas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
</head>
<body>
<h1>Recetas</h1>
<form action="#" th:action="@{/recipeEntities/crear}" th:object="${recipeEntity}" method="post">
    <input type="text" th:field="*{nombre}" placeholder="Nombre"/>
    <textarea th:field="*{descripcion}" placeholder="Descripción"></textarea>
    <input type="number" th:field="*{tiempo}" placeholder="Tiempo"/>

    <h2>Ingredientes</h2>
    <div id="ingredientes">
        <div th:each="ingredientEntity, stat : *{ingredientes}">
            <div>
                <label>Nombre:</label>
                <input type="text" th:field="*{ingredientes[__${stat.index}__].nombre}" placeholder="Nombre del ingredientEntity"/>
            </div>
            <div>
                <label>Cantidad:</label>
                <input type="number" th:field="*{ingredientes[__${stat.index}__].cantidad}" step="any" placeholder="Cantidad"/>
            </div>
        </div>
    </div>

    <button type="button" onclick="agregarIngrediente()">Agregar Ingrediente</button>

    <button type="submit">Guardar Receta</button>
</form>

<h2>Menú Semanal</h2>
<div th:each="recipeEntity : ${recipeEntities}">
    <p th:text="${recipeEntity.nombre}">Nombre de la recipeEntity</p>
    <p th:text="${recipeEntity.descripcion}">Descripción de la recipeEntity</p>
</div>

<h2>Lista de la Compra</h2>
<ul>
    <li th:each="ingredientEntity, cantidad : ${listaCompra}">
        <span th:text="${ingredientEntity}"></span>: <span th:text="${cantidad}"></span>
    </li>
</ul>

<script th:inline="javascript">
    /*<![CDATA[*/
    var ingredienteIndex = /*[[${recipeEntity.ingredientes != null ? #lists.size(recipeEntity.ingredientes) : 0}]]*/ 0;

    $(document).ready(function() {
        // Inicializar select2 para la búsqueda de ingredientes
        $('#ingredientEntity-buscador').select2({
            ajax: {
                url: '/recipeEntities/ingredientes',
                dataType: 'json',
                processResults: function(data) {
                    return {
                        results: data.map(function(ingredientEntity) {
                            return {
                                id: ingredientEntity.id,
                                text: ingredientEntity.nombre
                            };
                        })
                    };
                }
            },
            tags: true,
            createTag: function(params) {
                return {
                    id: params.term,
                    text: params.term,
                    newOption: true
                };
            },
            placeholder: 'Buscar o agregar un ingredientEntity',
            minimumInputLength: 1
        }).on('select2:select', function(e) {
            var data = e.params.data;
            agregarIngrediente(data.text);
        });
    });

    function agregarIngrediente(nombre) {
        var template =
            '<div>' +
            '   <label>Nombre:</label>' +
            '   <input type="text" name="ingredientes[' + ingredienteIndex + '].nombre" value="' + nombre + '" placeholder="Nombre del ingredientEntity"/>' +
            '</div>' +
            '<div>' +
            '   <label>Cantidad:</label>' +
            '   <input type="number" name="ingredientes[' + ingredienteIndex + '].cantidad" step="any" placeholder="Cantidad"/>' +
            '</div>' +
            '<div>';

        var newIngredient = document.createElement('div');
        newIngredient.innerHTML = template;
        document.getElementById('ingredientes').appendChild(newIngredient);

        ingredienteIndex++;
    }
    /*]]>*/
</script>

<select id="ingredientEntity-buscador"></select>

</body>
</html>
